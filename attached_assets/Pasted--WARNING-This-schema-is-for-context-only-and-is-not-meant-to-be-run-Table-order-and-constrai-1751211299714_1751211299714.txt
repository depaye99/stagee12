-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action character varying NOT NULL,
  table_name character varying,
  record_id uuid,
  old_values jsonb,
  new_values jsonb,
  changes jsonb,
  ip_address inet,
  user_agent text,
  session_id character varying,
  request_id character varying,
  description text,
  severity character varying DEFAULT 'info'::character varying CHECK (severity::text = ANY (ARRAY['info'::character varying::text, 'warning'::character varying::text, 'error'::character varying::text, 'critical'::character varying::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT audit_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.demande_documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  demande_id uuid,
  nom_fichier text NOT NULL,
  type_fichier text,
  taille_fichier integer,
  url_fichier text,
  created_at timestamp with time zone DEFAULT now(),
  uploaded_by uuid,
  CONSTRAINT demande_documents_pkey PRIMARY KEY (id),
  CONSTRAINT demande_documents_demande_id_fkey FOREIGN KEY (demande_id) REFERENCES public.demandes(id),
  CONSTRAINT demande_documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.demandes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  stagiaire_id uuid NOT NULL,
  tuteur_id uuid,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['stage_academique'::character varying::text, 'stage_professionnel'::character varying::text, 'conge'::character varying::text, 'prolongation'::character varying::text, 'attestation'::character varying::text, 'evaluation'::character varying::text, 'changement_tuteur'::character varying::text])),
  titre character varying NOT NULL,
  description text,
  justification text,
  statut character varying DEFAULT 'en_attente'::character varying CHECK (statut::text = ANY (ARRAY['en_attente'::character varying::text, 'approuvee'::character varying::text, 'rejetee'::character varying::text, 'en_cours'::character varying::text, 'terminee'::character varying::text])),
  priorite character varying DEFAULT 'normale'::character varying CHECK (priorite::text = ANY (ARRAY['basse'::character varying::text, 'normale'::character varying::text, 'haute'::character varying::text, 'urgente'::character varying::text])),
  date_demande timestamp with time zone DEFAULT now(),
  date_limite timestamp with time zone,
  date_reponse timestamp with time zone,
  date_traitement timestamp with time zone,
  commentaire_reponse text,
  commentaire_interne text,
  documents_requis ARRAY,
  documents_fournis ARRAY,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  documents_joints ARRAY,
  pieces_jointes jsonb,
  CONSTRAINT demandes_pkey PRIMARY KEY (id),
  CONSTRAINT demandes_tuteur_id_fkey FOREIGN KEY (tuteur_id) REFERENCES public.users(id),
  CONSTRAINT demandes_stagiaire_id_fkey FOREIGN KEY (stagiaire_id) REFERENCES public.stagiaires(id)
);
CREATE TABLE public.documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  nom character varying NOT NULL,
  nom_original character varying,
  type character varying NOT NULL,
  extension character varying,
  taille integer NOT NULL CHECK (taille > 0),
  url text NOT NULL,
  user_id uuid NOT NULL,
  demande_id uuid,
  stagiaire_id uuid,
  description text,
  tags ARRAY,
  is_public boolean DEFAULT false,
  is_template boolean DEFAULT false,
  version integer DEFAULT 1,
  access_level character varying DEFAULT 'private'::character varying CHECK (access_level::text = ANY (ARRAY['private'::character varying::text, 'internal'::character varying::text, 'public'::character varying::text])),
  download_count integer DEFAULT 0,
  last_downloaded timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT documents_pkey PRIMARY KEY (id),
  CONSTRAINT documents_stagiaire_id_fkey FOREIGN KEY (stagiaire_id) REFERENCES public.stagiaires(id),
  CONSTRAINT documents_demande_id_fkey FOREIGN KEY (demande_id) REFERENCES public.demandes(id),
  CONSTRAINT documents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.email_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  type text NOT NULL,
  sujet text NOT NULL,
  contenu text NOT NULL,
  envoye boolean DEFAULT false,
  date_envoi timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT email_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.evaluations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  stagiaire_id uuid NOT NULL,
  evaluateur_id uuid NOT NULL,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['mi_parcours'::character varying::text, 'finale'::character varying::text, 'auto_evaluation'::character varying::text, 'mensuelle'::character varying::text, 'projet'::character varying::text])),
  periode character varying,
  date_evaluation date NOT NULL,
  note_globale numeric CHECK (note_globale >= 0::numeric AND note_globale <= 20::numeric),
  competences_techniques numeric CHECK (competences_techniques >= 0::numeric AND competences_techniques <= 20::numeric),
  competences_relationnelles numeric CHECK (competences_relationnelles >= 0::numeric AND competences_relationnelles <= 20::numeric),
  autonomie numeric CHECK (autonomie >= 0::numeric AND autonomie <= 20::numeric),
  initiative numeric CHECK (initiative >= 0::numeric AND initiative <= 20::numeric),
  ponctualite numeric CHECK (ponctualite >= 0::numeric AND ponctualite <= 20::numeric),
  points_forts text,
  points_amelioration text,
  commentaires text,
  recommandations text,
  objectifs_suivants text,
  duree_evaluation integer,
  is_validated boolean DEFAULT false,
  validated_by uuid,
  validated_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT evaluations_pkey PRIMARY KEY (id),
  CONSTRAINT evaluations_validated_by_fkey FOREIGN KEY (validated_by) REFERENCES public.users(id),
  CONSTRAINT evaluations_evaluateur_id_fkey FOREIGN KEY (evaluateur_id) REFERENCES public.users(id),
  CONSTRAINT evaluations_stagiaire_id_fkey FOREIGN KEY (stagiaire_id) REFERENCES public.stagiaires(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  titre character varying NOT NULL,
  message text NOT NULL,
  type character varying DEFAULT 'info'::character varying CHECK (type::text = ANY (ARRAY['info'::character varying::text, 'success'::character varying::text, 'warning'::character varying::text, 'error'::character varying::text, 'reminder'::character varying::text])),
  lu boolean DEFAULT false,
  date timestamp with time zone DEFAULT now(),
  date_lecture timestamp with time zone,
  expire_at timestamp with time zone,
  related_type character varying,
  related_id uuid,
  action_url text,
  action_label character varying,
  priority character varying DEFAULT 'normal'::character varying CHECK (priority::text = ANY (ARRAY['low'::character varying::text, 'normal'::character varying::text, 'high'::character varying::text, 'critical'::character varying::text])),
  category character varying,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.stagiaires (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  tuteur_id uuid,
  entreprise character varying,
  poste character varying,
  date_debut date,
  date_fin date,
  duree_mois integer DEFAULT 
CASE
    WHEN ((date_debut IS NOT NULL) AND (date_fin IS NOT NULL)) THEN ((((EXTRACT(year FROM date_fin) - EXTRACT(year FROM date_debut)))::integer * 12) + ((EXTRACT(month FROM date_fin) - EXTRACT(month FROM date_debut)))::integer)
    ELSE NULL::integer
END,
  statut character varying DEFAULT 'actif'::character varying CHECK (statut::text = ANY (ARRAY['actif'::character varying::text, 'termine'::character varying::text, 'suspendu'::character varying::text, 'en_attente'::character varying::text])),
  notes text,
  objectifs text,
  competences_acquises ARRAY,
  etablissement character varying,
  niveau_etude character varying,
  specialite character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT stagiaires_pkey PRIMARY KEY (id),
  CONSTRAINT stagiaires_tuteur_id_fkey FOREIGN KEY (tuteur_id) REFERENCES public.users(id),
  CONSTRAINT stagiaires_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.system_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  key character varying NOT NULL UNIQUE,
  value text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  nom character varying NOT NULL,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['email'::character varying::text, 'document'::character varying::text, 'rapport'::character varying::text, 'contrat'::character varying::text, 'attestation'::character varying::text])),
  contenu text NOT NULL,
  subject character varying,
  variables ARRAY,
  description text,
  category character varying,
  tags ARRAY,
  is_active boolean DEFAULT true,
  is_default boolean DEFAULT false,
  version character varying DEFAULT '1.0'::character varying,
  created_by uuid NOT NULL,
  visibility character varying DEFAULT 'private'::character varying CHECK (visibility::text = ANY (ARRAY['private'::character varying::text, 'department'::character varying::text, 'public'::character varying::text])),
  usage_count integer DEFAULT 0,
  last_used timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT templates_pkey PRIMARY KEY (id),
  CONSTRAINT templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  role character varying DEFAULT 'stagiaire'::character varying CHECK (role::text = ANY (ARRAY['admin'::character varying::text, 'rh'::character varying::text, 'tuteur'::character varying::text, 'stagiaire'::character varying::text])),
  phone character varying,
  address text,
  department character varying,
  position character varying,
  avatar_url text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_login timestamp with time zone,
  password_hash character varying,
  email_verified boolean DEFAULT false,
  reset_token character varying,
  reset_token_expires timestamp with time zone,
  preferences jsonb DEFAULT '{}'::jsonb,
  settings jsonb DEFAULT '{}'::jsonb,
  profile_completed boolean DEFAULT false,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);